<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Page</title>
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="stylesheet" href="liyoober.css">
</head>
<body>
    <div class="container">
        <div class="login-box">
            <h2 id="login-title">Login account</h2>
            <div id="error-message" class="error-message" style="display: none;"></div>
            <div id="succes-message" class="succes-message" style="display: none;"></div>
            <form>
                <div class="input-box">
                    <input type="email" id="email" required>
                    <label id="email-label">Email</label>
                    <span class="icon"></span>
                </div>
                <div class="input-box">
                    <input type="password" id="password" required>
                    <label id="password-label">Password</label>
                    <span class="icon"></span>
                </div>
                <button id="loginBtn" type="button">Login</button>
                 <p><a href="signup.html" id="new-user-text">New user?</a></p>
                <p><a href="forgot.html" id="forgot-password-link">Forgot password?</a></p>
            </form>
        </div>
        <div class="welcome-box">
            <h2 id="langu">Choose your language</h2>
            <select id="languageSelector">
        <option value="en">English</option>
        <option value="so">Somali</option>
    </select>
            <h2 id="welcome-title">WELCOME BACK!</h2>
            <p id="contact-message">If you experience any problems, please contact us.</p>
            <a href="https://wa.me/252672146979" target="_blank" id="contact-link">contact</a>
            <p id="injury-text">I injury</p>
            <a href="Injury.html" id="injury-link">Injury</a>
        </div>
    </div>

    <script type="module">
    
    // translations object
const translations = {
    en: {
        loginTitle: 'Login account',
        loginBtn: 'Login',
        langu: 'choose your language',
        emailLabel: 'Email',
        registerLink: 'Register',
        passwordLabel: 'Password',
        newUserText: 'New user?',
        forgotPasswordText: 'Forgot password?',
        welcomeTitle: 'WELCOME BACK!',
        contactMessage: 'If you experience any problems, please contact us.',
        contactLinkText: 'contact',
        injuryText: 'I injury',
        injuryLinkText: 'Injury',
        invalidEmail: 'Please enter a valid email address.',
        missingPassword: 'Please enter your password.',
        shortPassword: 'Password must be at least 6 characters long.',
        emailNotVerified: 'Please verify your email.',
        disabledAccount: 'This account has been disabled. Please contact support.',
        noAccountFound: 'incorrect email or password .',
        incorrectPassword: 'Incorrect password. Please try again.',
        blockedAccount: 'This account has been blocked.',
        loginLimitReached: 'You have reached your login limit for this month. Please wait for the next month.',
        successfulLogin: 'Login Successful! You have {attempts} logins left this month.'
    },
    so: {
        loginTitle: 'Galitaanka akaawnta',
        loginBtn: 'Gal',
        langu: 'Dooro luuqada',
        emailLabel: 'Email',
        registerLink: 'Diwaangali',
        passwordLabel: 'Erayga Sirta',
        newUserText: 'Ma cusubtahay',
        forgotPasswordText: 'Ma ilowday erayga sirta?',
        welcomeTitle: 'SOO DHOWOW!',
        contactMessage: 'Haddii aad la kulanto wax dhibaato ah, fadlan nala soo xiriir.',
        contactLinkText: 'la xiriir',
        injuryText: 'Anigu dhaawac ayaan ahay',
        injuryLinkText: 'Dhaawac',
        invalidEmail: 'Fadlan geli cinwaanka email saxda ah.',
        missingPassword: 'Fadlan geli erayga sirta ah.',
        shortPassword: 'Erayga sirta ah wuxuu u baahan yahay ugu yaraan 6 xaraf.',
        emailNotVerified: 'Fadlan xaqiiji emailkaaga.',
        disabledAccount: 'Akaawntigan waa la hakiyey. Fadlan la xiriir taageerada.',
        noAccountFound: 'email ama furaha aya khaldan.',
        incorrectPassword: 'Erayga sirta ah waa qalad. Fadlan isku day mar kale.',
        blockedAccount: 'Akaawntigan waa la xayiray.',
        loginLimitReached: 'Waxaad gaartay xadka gelitaanka ee bishan. Fadlan sug bilaha soo socda.',
        successfulLogin: 'Gelitaanka guuleystay! Waxaad leedahay {attempts} gelitaan oo ka hadhay bishan.'
    }
};

let currentLanguage = 'en'; // default to English

document.getElementById('languageSelector').addEventListener('change', (event) => {
    currentLanguage = event.target.value;
    translatePage();
});

function translatePage() {
    // Apply translations to page elements
    document.getElementById('login-title').innerText = translations[currentLanguage].loginTitle;
    document.getElementById('email-label').innerText = translations[currentLanguage].emailLabel;
    document.getElementById('password-label').innerText = translations[currentLanguage].passwordLabel;
    document.getElementById('new-user-text').innerHTML = translations[currentLanguage].newUserText;
    document.getElementById('forgot-password-link').innerText = translations[currentLanguage].forgotPasswordText;
    document.getElementById('welcome-title').innerText = translations[currentLanguage].welcomeTitle;
    document.getElementById('contact-message').innerText = translations[currentLanguage].contactMessage;
    document.getElementById('contact-link').innerText = translations[currentLanguage].contactLinkText;
    document.getElementById('injury-text').innerText = translations[currentLanguage].injuryText;
    document.getElementById('injury-link').innerText = translations[currentLanguage].injuryLinkText;
    document.getElementById('loginBtn').innerText = translations[currentLanguage].loginBtn;
    document.getElementById('langu').innerText = translations[currentLanguage].langu;}
// Firebase imports
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
import { getDatabase, ref, get, set, update } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

// Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyC3TawidTEkY318dTUXX4WDkZTMWiSQ24Y",
  authDomain: "storage-b0f0c.firebaseapp.com",
  databaseURL: "https://storage-b0f0c-default-rtdb.firebaseio.com",
  projectId: "storage-b0f0c",
  storageBucket: "storage-b0f0c.firebasestorage.app",
  messagingSenderId: "240490334618",
  appId: "1:240490334618:web:73f77de6ff9ab18e339223",
  measurementId: "G-97984G4JJD"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const database = getDatabase(app);

// Function to get current date as YYYY-MM
function getCurrentMonth() {
    return new Date().toISOString().substring(0, 7); // Example: "2025-03"
}
// Hubinta haddii isticmaalaha uu galo

// Handle Login
document.getElementById('loginBtn').addEventListener('click', async () => {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const errorMessage = document.getElementById('error-message');
    const succesMessage = document.getElementById('succes-message');

    // Clear previous messages
    errorMessage.style.display = 'none';
    errorMessage.innerText = '';
    succesMessage.style.display = 'none';
    succesMessage.innerText = '';

    // Email format validation
    const emailPattern = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6}$/;
    if (!emailPattern.test(email)) {
        errorMessage.style.display = 'block';
        errorMessage.innerText = translations[currentLanguage].invalidEmail;
        return;
    }

    if (!password) {
        errorMessage.style.display = 'block';
        errorMessage.innerText = translations[currentLanguage].missingPassword;
        return;
    }

    if (password.length < 6) {
        errorMessage.style.display = 'block';
        errorMessage.innerText = translations[currentLanguage].shortPassword;
        return;
    }

    try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;

        const userRef = ref(database, `users/${user.uid}`);
        const snapshot = await get(userRef);

        const currentMonth = getCurrentMonth();
        let loginAttempts = 10;

        if (snapshot.exists()) {
            const userData = snapshot.val();

            if (userData.isDisabled) {
                errorMessage.style.display = 'block';
                errorMessage.innerText = translations[currentLanguage].disabledAccount;
                return;
            }

            if (userData.lastLoginMonth && userData.lastLoginMonth === currentMonth) {
                loginAttempts = userData.loginAttempts ?? 10;
            } else {
                loginAttempts = 10; // Reset login attempts for the new month
            }

             if (loginAttempts <= 0) {
    errorMessage.style.display = 'block';
    errorMessage.innerText = translations[currentLanguage].loginLimitReached;

    // Hel URL-ka hadda jira
    let currentUrl = window.location.href;

    // Go'aami haddii URL-ku horey u leeyahay '?'
    let separator = currentUrl.includes('?') ? '&' : '?';

    // Ku dar qoraalka cusub
    let newUrl = currentUrl + separator + 'reachedleveluser=eiE96U4cTC663636S3tV';

    // Bedel URL-ka iyadoo aan reload dhicin
    window.history.replaceState({}, '', newUrl);
     return;            
}
            loginAttempts--; // Decrease attempts
await update(userRef, {
    loginAttempts: loginAttempts,
    lastLoginMonth: currentMonth,
    isLoggedIn: true
});

// Soo qaado name iyo number
const name = userData.username || "";
const number = userData.number || "";

// Samee deep link
const deepLink = `creatercon://open?uid=${encodeURIComponent(user.uid)}&email=${encodeURIComponent(email)}&name=${encodeURIComponent(name)}&number=${encodeURIComponent(number)}`;

alert(translations[currentLanguage].successfulLogin.replace('{attempts}', loginAttempts));

// Fur app-ka halkii "home.html"

    window.location.href = deepLink;

        } else {
            errorMessage.style.display = 'block';
            errorMessage.innerText = translations[currentLanguage].noAccountFound;
        }
    } catch (error) {
        if (error.code === 'auth/wrong-password') {
            errorMessage.style.display = 'block';
            errorMessage.innerText = translations[currentLanguage].incorrectPassword;
        } else if (error.code === 'auth/user-disabled') {
            errorMessage.style.display = 'block';
            errorMessage.innerText = translations[currentLanguage].blockedAccount;
        } else {
            errorMessage.style.display = 'block';
            errorMessage.innerText = translations[currentLanguage].noAccountFound;
        }
    }
});
</script>
</body>
                        </html>
